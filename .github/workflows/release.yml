name: Release

permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.0
      - name: Run Tests
        run: zig build test

  build-library:
    name: Build Library (${{ matrix.target }})
    needs: test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-windows
          - x86-windows
          - x86_64-linux
          - x86-linux
          - aarch64-linux
          - x86_64-macos
          - aarch64-macos
          - x86_64-freestanding
          - x86-freestanding
          - aarch64-freestanding
          - riscv64-freestanding
          - arm-freestanding
    steps:
      - uses: actions/checkout@v5
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.0
      
      - name: Build Library (install artifacts)
        run: zig build install -Doptimize=ReleaseSafe -Dtarget=${{ matrix.target }}

      - name: Prepare Release Artifacts
        run: |
          mkdir -p release
          echo "Listing zig-out directory:"
          ls -la zig-out || true
          echo "Finding built library files:"
          find zig-out -type f -name 'libdownloader*' -o -name 'downloader.*' -print || true

          # Copy any matching library files to the release directory
          FOUND=0
          for f in $(find zig-out -type f -name 'libdownloader*' -o -name 'downloader.*' -print); do
            echo "Copying $f -> release/$(basename "$f")-${{ matrix.target }}"
            cp "$f" "release/$(basename "$f")-${{ matrix.target }}" && FOUND=1 || true
          done

          # If no artifacts were found, zip the full build output for debugging
          if [ "$FOUND" -eq 0 ]; then
            echo "No library artifacts found for target ${{ matrix.target }}. Creating debug zip..."
            zip -r release/zig-out-${{ matrix.target }}.zip zig-out || true
            echo "No library artifacts were produced for target ${{ matrix.target }}" > release/NO_ARTIFACTS_${{ matrix.target }}.txt
          fi

      - name: Show release directory before uploading artifact
        run: ls -la release || true

      - name: Upload artifacts to workflow
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.target }}
          path: release

  upload-release:
    name: Upload Release Artifacts
    needs: [build-library]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          path: release

      - name: Show downloaded release directory tree
        run: |
          echo "Top-level release/ contents:"
          ls -la release || true
          echo "All files under release/:"
          find release -type f -print || true

      - name: Flatten release artifacts for upload (libs and binaries)
        run: |
          mkdir -p release_flat
          FOUND=0

          # Find and copy library and binary artifacts. Include:
          # - static libs: .a, .lib
          # - shared libs: .so, .dylib, .dll
          # - files named lib* or containing downloader (libdownloader*, *downloader*)
          # - any executable file (for binaries without extensions)
          find release -type f \( -iname '*.a' -o -iname '*.lib' -o -iname '*.so' -o -iname '*.dylib' -o -iname '*.dll' -o -iname 'lib*' -o -iname '*downloader*' -o -executable \) -print0 | while IFS= read -r -d '' f; do
            artifact_dir=$(dirname "$f" | xargs -I {} basename {})
            filename=$(basename "$f")
            dest="release_flat/${artifact_dir}-${filename}"
            echo "Copying $f -> $dest"
            cp "$f" "$dest" && FOUND=1 || true
          done

          # Also include any top-level files matching common binary/library extensions (in case artifacts leaked to top-level)
          for f in release/*; do
            if [ -f "$f" ]; then
              case "$(basename "$f")" in
                *.a|*.lib|*.so|*.dylib|*.dll|lib*|*downloader*)
                  echo "Copying top-level $f -> release_flat/$(basename \"$f\")"
                  cp "$f" "release_flat/$(basename "$f")" && FOUND=1 || true
                  ;;
                *)
                  echo "Skipping non-library top-level file: $f"
                  ;;
              esac
            fi
          done

          if [ "$FOUND" -eq 0 ]; then
            echo "No library/binary artifacts found to upload in release/"
            ls -la release || true
            echo "Contents of release_flat:" && ls -la release_flat || true
          fi

      - name: Show flattened release files
        run: ls -la release_flat || true

      - name: Upload release artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: release_flat/**
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  update-release:
    name: Update Release Description
    needs: [upload-release]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Get Release URL
        id: get_url
        run: echo "url=https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz" >> $GITHUB_OUTPUT

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.0

      - name: Calculate Hash
        id: calc_hash
        run: |
          zig fetch --save ${{ steps.get_url.outputs.url }} || true
          # Extract hash from build.zig.zon (it's updated by zig fetch)
          HASH=$(grep '.hash =' build.zig.zon | cut -d '"' -f 2)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Update Release Body
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ${{ github.event.release.body }}

            ## üöÄ Installation

            ### Option A ‚Äî Automatic (Recommended)

            Run this to install the dependency and automatically save the hash:

            ```bash
            zig fetch --save https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```

            After running, Zig updates your `build.zig.zon` with something like:

            ```zig
            .dependencies = .{
                .downloader = .{
                    .url = "https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz",
                    .hash = "${{ steps.calc_hash.outputs.hash }}",
                },
            },
            ```

            ### Option B ‚Äî Manual

            ```bash
            zig fetch --hash https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```

            Copy that hash into:

            ```zig
            .hash = "<your_hash_here>" // which is ${{ steps.calc_hash.outputs.hash }}
            ```

            ## ‚¨áÔ∏è Downloads (Prebuilt Library)

            | Platform | Architecture | File |
            |----------|--------------|------|
            | Windows | x86_64 (64-bit) | [downloader-x86_64-windows.lib](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/downloader-x86_64-windows.lib) |
            | Windows | x86 (32-bit) | [downloader-x86-windows.lib](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/downloader-x86-windows.lib) |
            | Linux | x86_64 (64-bit) | [libdownloader-x86_64-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-x86_64-linux.a) |
            | Linux | x86 (32-bit) | [libdownloader-x86-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-x86-linux.a) |
            | Linux | aarch64 (ARM64) | [libdownloader-aarch64-linux.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-aarch64-linux.a) |
            | macOS | x86_64 (Intel 64-bit) | [libdownloader-x86_64-macos.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-x86_64-macos.a) |
            | macOS | aarch64 (Apple Silicon) | [libdownloader-aarch64-macos.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-aarch64-macos.a) |
            | Bare Metal | x86_64 | [libdownloader-x86_64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-x86_64-freestanding.a) |
            | Bare Metal | x86 (32-bit) | [libdownloader-x86-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-x86-freestanding.a) |
            | Bare Metal | aarch64 | [libdownloader-aarch64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-aarch64-freestanding.a) |
            | Bare Metal | RISC-V 64 | [libdownloader-riscv64-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-riscv64-freestanding.a) |
            | Bare Metal | ARM (32-bit) | [libdownloader-arm-freestanding.a](https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/libdownloader-arm-freestanding.a) |

            ### üõ†Ô∏è Using Prebuilt Libraries

            1. Download the library for your platform.
            2. Place it in your project (e.g., in a `libs/` folder).
            3. Update your `build.zig`:

            ```zig
            // Assuming you placed the library in `libs/`
            exe.addLibraryPath(b.path("libs"));
            exe.linkSystemLibrary("downloader");
            ```

            ## üìö Documentation

            Full documentation is available at: https://muhammad-fiaz.github.io/downloader.zig/

            ## üíñ Support

            If you find this library useful, please consider [sponsoring](https://github.com/sponsors/muhammad-fiaz)!
